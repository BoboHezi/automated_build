<?xml version='1.1' encoding='UTF-8'?>
<flow-definition plugin="workflow-job@2.40">
  <actions>
    <org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobAction plugin="pipeline-model-definition@1.8.4"/>
    <org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobPropertyTrackerAction plugin="pipeline-model-definition@1.8.4">
      <jobProperties/>
      <triggers/>
      <parameters/>
      <options/>
    </org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobPropertyTrackerAction>
  </actions>
  <description></description>
  <keepDependencies>false</keepDependencies>
  <properties>
    <com.dabsquared.gitlabjenkins.connection.GitLabConnectionProperty plugin="gitlab-plugin@1.5.20">
      <gitLabConnection></gitLabConnection>
      <jobCredentialId></jobCredentialId>
      <useAlternativeCredential>false</useAlternativeCredential>
    </com.dabsquared.gitlabjenkins.connection.GitLabConnectionProperty>
    <com.gitee.jenkins.connection.GiteeConnectionProperty plugin="gitee@1.2.5">
      <giteeConnection>Gitee</giteeConnection>
    </com.gitee.jenkins.connection.GiteeConnectionProperty>
    <hudson.model.ParametersDefinitionProperty>
      <parameterDefinitions>
        <hudson.model.StringParameterDefinition>
          <name>project_name</name>
          <description>上传项目</description>
          <defaultValue>g1930epq_v15_hl</defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>code_dir</name>
          <description>编译服务器上，项目所属仓库的位置</description>
          <defaultValue>/data/58N/</defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>server_ip_address</name>
          <description>编译服务器IP地址</description>
          <defaultValue>192.168.151.238</defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>server_hostname</name>
          <description>编译服务器，SSH用户名</description>
          <defaultValue>server</defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.PasswordParameterDefinition>
          <name>server_passwd</name>
          <description>编译服务器，SSH密码</description>
          <defaultValue>{AQAAABAAAAAQUAe+yE7L+/diu6VPLob1t/u4P/e8qDV+oOu1qN3U93w=}</defaultValue>
        </hudson.model.PasswordParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>zip_file</name>
          <description>指定上传文件</description>
          <defaultValue></defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>ftp_host</name>
          <description>指定上传ftp地址</description>
          <defaultValue>192.168.150.30</defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>ftp_user</name>
          <description>指定上传ftp用户</description>
          <defaultValue>hongxiangyuan</defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.PasswordParameterDefinition>
          <name>ftp_user_passwd</name>
          <description>指定上传ftp用户密码</description>
          <defaultValue>{AQAAABAAAAAghqzlK+sR5HtYA/rpFMERRBoNGlfYnKsRH35QBrnc4WyMg20ubWHohmgpLSIUK/n8}</defaultValue>
        </hudson.model.PasswordParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>script_path</name>
          <description>no not edit</description>
          <defaultValue>/home/server/.jenkins/script</defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
      </parameterDefinitions>
    </hudson.model.ParametersDefinitionProperty>
  </properties>
  <definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition" plugin="workflow-cps@2.90">
    <script>pipeline {
    agent &apos;any&apos;
    stages {
        stage(&apos;prepare&apos;) {
            steps {
                script {
                    println &quot;project_name: ${project_name}&quot;
                    println &quot;code_dir: ${code_dir}&quot;
                    println &quot;server_hostname: ${server_hostname}&quot;
                    println &quot;server_ip_address: ${server_ip_address}&quot;
                    println &quot;server_passwd: ${server_passwd}&quot;
                    println &quot;zip_file: ${zip_file}&quot;
                    println &quot;ftp_host: ${ftp_host}&quot;
                    println &quot;ftp_user: ${ftp_user}&quot;
                    println &quot;ftp_user_passwd: ${ftp_user_passwd}&quot;
                }
            }
        }
        stage(&apos;prepare-jenkins-server&apos;) {
            steps {
                script {
                    sh &apos;&apos;&apos;
                    if ! type sshpass &gt;/dev/null 2&gt;&amp;1; then
                        echo -e &quot;\nprepare-jenkins-server: install sshpass&quot;
                        yum install sshpass -y
                    fi
                    if ! type pip3 &gt;/dev/null 2&gt;&amp;1; then
                        echo -e &quot;\nprepare-jenkins-server: install python3-pip&quot;
                        yum install python3-pip -y
                    fi
                    &apos;&apos;&apos;
                }
            }
        }
        stage(&apos;prepare-host-mkdir&apos;) {
            steps {
                sh &apos;&apos;&apos;
                sshpass -p &quot;$server_passwd&quot; ssh -o StrictHostKeyChecking=no &quot;$server_hostname@$server_ip_address&quot; &lt;&lt; EOF

                if [ ! -d &quot;$script_path&quot; ]; then
                    echo -e &quot;\ncreate path $script_path&quot;
                    mkdir -p &quot;$script_path&quot;
                fi
                cd $script_path
                pwd
                &apos;&apos;&apos;
            }
        }
        stage(&apos;prepare-host-upload-script&apos;) {
            steps {
                script {
                    sh &apos;&apos;&apos;
                    set +e
                    sshpass -p &quot;$server_passwd&quot; scp -r $script_path &quot;$server_hostname@$server_ip_address&quot;:/home/server/.jenkins &gt; /dev/null 2&gt;&amp;1
                    
                    sshpass -p &quot;$server_passwd&quot; ssh -o StrictHostKeyChecking=no &quot;$server_hostname@$server_ip_address&quot; &lt;&lt; EOF
                    cd $script_path
                    pwd
                    ./link.sh $code_dir
                    &apos;&apos;&apos;
                }
            }
        }
        stage(&apos;upload&apos;) {
            steps {
                script {
                    sh &apos;&apos;&apos;
                    sshpass -p &quot;$server_passwd&quot; ssh -o StrictHostKeyChecking=no &quot;$server_hostname@$server_ip_address&quot; &lt;&lt; EOF
                    if [ ! -d &quot;$code_dir&quot; ]; then
                    echo &quot;Project code directory does not exist!!!&quot;
                    exit -1;
                    fi
                    
                    cd &quot;$code_dir&quot;
                    echo &quot;&quot;
                    echo -------------------------------------------------
                    echo code_dir: 
                    pwd
                    echo -------------------------------------------------
                    echo &quot;&quot;
                    
                    if [ ! -f upload_ftp.py ]; then
                    echo &quot;File upload_ftp.py does not exist!!!&quot;
                    exit -2;
                    fi

                    echo -e &quot;upload_ftp.py -p $project_name -f $zip_file -i $ftp_host -u $ftp_user -c $ftp_user_passwd&quot;
                    ./upload_ftp.py -p &quot;$project_name&quot; -f &quot;$zip_file&quot; -i &quot;$ftp_host&quot; -u &quot;$ftp_user&quot; -c &quot;$ftp_user_passwd&quot;
                    &apos;&apos;&apos;
                }
            }
        }
    }
}</script>
    <sandbox>true</sandbox>
  </definition>
  <triggers/>
  <disabled>false</disabled>
</flow-definition>